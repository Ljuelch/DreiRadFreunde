<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin ‚Äì DreiRadFreunde</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="icon" type="image/png" href="assets/drfImg/IMG_6765.jpeg">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            background: url('assets/drfImg/IMG_6765.jpeg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }

        .container {
            background: rgba(255, 255, 255, 0.85);
            color: #000;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .login-container {
            max-width: 400px;
            margin: 0 auto;
            margin-top: 10vh;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        h1, h3, h5 {
            color: #111;
        }

        .btn-outline-secondary {
            color: #333;
            border-color: #333;
        }

        .btn-outline-secondary:hover {
            background-color: #333;
            color: #fff;
        }

        .section-divider {
            border-top: 2px solid #dee2e6;
            margin: 3rem 0 2rem 0;
            padding-top: 2rem;
        }

        .tour-item {
            background: rgba(248, 249, 250, 0.8);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .tour-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tour-info h6 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .tour-info small {
            color: #666;
        }

        .etappen-list {
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .etappen-list.show {
            display: block;
        }

        .etappe-item {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .etappe-info {
            flex: 1;
        }

        .etappe-info strong {
            color: #495057;
            font-size: 0.9rem;
        }

        .etappe-info small {
            color: #6c757d;
            display: block;
            margin-top: 0.25rem;
        }

        /* Gelbe Hervorhebung f√ºr Platzhalter */
        .etappe-placeholder {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
        }

        .etappe-placeholder .etappe-info strong {
            color: #856404 !important;
        }

        .etappe-placeholder .etappe-info small {
            color: #856404 !important;
        }

        .placeholder-warning {
            font-size: 0.8rem;
            color: #856404;
            font-style: italic;
            margin-top: 0.25rem;
        }

        .btn-toggle-etappen {
            background: none;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-toggle-etappen:hover {
            background-color: #6c757d;
            color: white;
        }

        .btn-outline-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }

        .btn-outline-warning {
            border-color: #ffc107;
            color: #ffc107;
        }

        .btn-outline-warning:hover {
            background-color: #ffc107;
            color: #000;
        }

        #tours-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        #editSection {
            display: none;
        }

        #editSection.show {
            display: block;
        }

        .edit-header {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .edit-header h3 {
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .edit-header small {
            color: #856404;
        }

        /* Hide admin content until logged in */
        #adminContent {
            display: none;
        }

        #loginSection {
            display: block;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #666;
        }

        .alert {
            margin-top: 1rem;
        }

        /* Bildverwaltung Styles */
        .image-management {
            background: rgba(13, 202, 240, 0.1);
            border: 1px solid #0dcaf0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .image-slot {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 100px;
        }

        .image-slot.has-image {
            border: 2px solid #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .image-preview {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .image-info {
            flex: 1;
            margin: 0 1rem;
        }

        .image-info h6 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .image-info small {
            color: #666;
        }

        .image-actions {
            display: flex;
            gap: 0.5rem;
        }

        .available-images {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            background: #fff;
        }

        .available-image {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .available-image:hover {
            background: #f8f9fa;
        }

        .available-image img {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 1rem;
        }

        .available-image.selected {
            background: rgba(13, 202, 240, 0.2);
            border: 1px solid #0dcaf0;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4">

<!-- Login Section -->
<div id="loginSection">
    <div class="container login-container">
        <div class="login-header">
            <h1>DreiRadFreunde Admin</h1>
            <p>Bitte melde dich an, um fortzufahren</p>
        </div>

        <form id="loginForm">
            <div class="mb-3">
                <label for="loginEmail" class="form-label">E-Mail</label>
                <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
                <label for="loginPassword" class="form-label">Passwort</label>
                <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Anmelden</button>
        </form>

        <div id="loginError" class="alert alert-danger" style="display: none;"></div>
        <div id="loginLoading" class="loading" style="display: none; margin-top: 1rem;">Anmeldung l√§uft...</div>
    </div>
</div>

<!-- Admin Content -->
<div id="adminContent">
    <div class="container">
        <div class="admin-header">
            <h1>Admin Bereich ‚Äì DreiRadFreunde</h1>
            <div class="user-info">
                <span id="userEmail" class="text-muted"></span>
                <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Abmelden</button>
            </div>
        </div>

        <!-- Neue Tour erstellen -->
        <div id="createSection">
            <form id="fullTourForm">
                <h3 class="">Neue Tour erstellen</h3>

                <!-- Tour Info -->
                <div class="mb-2">
                    <label class="form-label">Jahr + Name</label>
                    <input type="text" id="tourId" class="form-control" placeholder="z.B. 2022 Radweg Deutsche Einheit" required />
                </div>
                <div class="mb-2">
                    <label class="form-label">Beschreibung</label>
                    <textarea id="tourDesc" class="form-control"></textarea>
                </div>

                <!-- Etappen -->
                <h5 class="mt-4">Etappen</h5>
                <div id="etappenContainer"></div>

                <button type="button" id="addEtappeBtn" class="btn btn-outline-secondary my-2">+ Etappe hinzuf√ºgen</button>

                <!-- Submit -->
                <button class="btn btn-primary d-block mt-3" type="submit">Tour + Etappen speichern</button>
            </form>
        </div>

        <!-- Tour bearbeiten -->
        <div id="editSection">
            <div class="edit-header">
                <h3>Tour bearbeiten</h3>
                <small>Du bearbeitest gerade eine vorhandene Tour. √Ñnderungen werden gespeichert.</small>
            </div>

            <form id="editTourForm">
                <!-- Tour Info -->
                <div class="mb-2">
                    <label class="form-label">Jahr + Name</label>
                    <input type="text" id="editTourId" class="form-control" required readonly />
                    <small class="text-muted">Der Tour-Name kann nicht ge√§ndert werden</small>
                </div>
                <div class="mb-2">
                    <label class="form-label">Beschreibung</label>
                    <textarea id="editTourDesc" class="form-control"></textarea>
                </div>

                <!-- Etappen -->
                <h5 class="mt-4">Etappen</h5>
                <div id="editEtappenContainer"></div>

                <button type="button" id="editAddEtappeBtn" class="btn btn-outline-secondary my-2">+ Etappe hinzuf√ºgen</button>

                <!-- Submit -->
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success" type="submit">√Ñnderungen speichern</button>
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn">Bearbeitung abbrechen</button>
                </div>
            </form>
        </div>

        <!-- Divider -->
        <div class="section-divider"></div>

        <!-- Touren l√∂schen -->
        <div class="mb-5">
            <h3 class="mb-3 mt-3">Vorhandene Touren verwalten</h3>
            <p class="text-muted">Hier kannst du vorhandene Touren bearbeiten oder l√∂schen. <strong>Achtung:</strong> Das L√∂schen kann nicht r√ºckg√§ngig gemacht werden!</p>

            <button id="loadToursBtn" class="btn btn-outline-secondary mb-3">Touren laden</button>

            <div id="tours-list"></div>
        </div>

        <!-- Bildverwaltung f√ºr Slider -->
        <div class="image-management">
            <h3 class="mb-3" style="color: #0dcaf0;">Slider-Bilder verwalten</h3>
            <p class="text-muted mb-4">Hier k√∂nnen Sie die 5 Bilder f√ºr den Slider auf der Startseite verwalten.</p>

            <div id="imageSlots">
                <!-- Wird dynamisch gef√ºllt -->
            </div>

            <div class="d-flex gap-2 mt-3">
                <button id="saveImagesBtn" class="btn btn-info">√Ñnderungen speichern</button>
                <button id="resetImagesBtn" class="btn btn-outline-secondary">Zur√ºcksetzen</button>
                <button id="loadImagesBtn" class="btn btn-outline-info">Aktuelle Bilder laden</button>
            </div>
        </div>
    </div>
</div>


<!-- Bildauswahl Modal -->
<div class="modal fade" id="imageSelectModal" tabindex="-1" aria-labelledby="imageSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageSelectModalLabel">Bild ausw√§hlen - Position <span id="currentSlot"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Neues Bild hochladen</h6>
                    <input type="file" class="form-control mb-2" id="imageUpload" accept="image/*">
                    <div id="uploadPreview" class="upload-preview mb-3" style="display: none;">
                        <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 6px; border: 1px solid #ddd;">
                        <div class="mt-2">
                            <button type="button" class="btn btn-success btn-sm" id="uploadImageBtn">Hochladen</button>
                            <button type="button" class="btn btn-secondary btn-sm" id="cancelUploadBtn">Abbrechen</button>
                        </div>
                    </div>
                </div>
                
                <div class="border-top pt-3">
                    <h6>Aus vorhandenen Bildern w√§hlen</h6>
                    <div id="availableImages" class="available-images">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="selectImageBtn" disabled>Bild ausw√§hlen</button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBKQVAV9j_dvd6w7xm8-lW-m30Z9GAW3Jc",
        authDomain: "dreiradfreunde-56aca.firebaseapp.com",
        projectId: "dreiradfreunde-56aca",
        storageBucket: "dreiradfreunde-56aca.appspot.com",
        messagingSenderId: "289133944113",
        appId: "1:289133944113:web:a03bc3aec8fd747aa4a410"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Auth elements
    const loginSection = document.getElementById('loginSection');
    const adminContent = document.getElementById('adminContent');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const loginLoading = document.getElementById('loginLoading');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');

    // Image management elements
    const imageSlotsContainer = document.getElementById('imageSlots');
    const saveImagesBtn = document.getElementById('saveImagesBtn');
    const resetImagesBtn = document.getElementById('resetImagesBtn');
    const loadImagesBtn = document.getElementById('loadImagesBtn');
    const imageSelectModal = new bootstrap.Modal(document.getElementById('imageSelectModal'));
    const availableImagesContainer = document.getElementById('availableImages');
    const selectImageBtn = document.getElementById('selectImageBtn');
    const currentSlotSpan = document.getElementById('currentSlot');
    const imageUpload = document.getElementById('imageUpload');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewImage = document.getElementById('previewImage');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');

    // Admin elements
    const etappenContainer = document.getElementById('etappenContainer');
    const addEtappeBtn = document.getElementById('addEtappeBtn');
    const loadToursBtn = document.getElementById('loadToursBtn');
    const toursList = document.getElementById('tours-list');
    const createSection = document.getElementById('createSection');
    const editSection = document.getElementById('editSection');
    const editEtappenContainer = document.getElementById('editEtappenContainer');
    const editAddEtappeBtn = document.getElementById('editAddEtappeBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    let currentEditTourId = null;
    let currentSliderImages = [];
    let availableImages = [];
    let currentEditingSlot = -1;
    let selectedImageIndex = -1;
    let uploadedFile = null;

    // Verf√ºgbare Bilder aus dem assets/drfImg Ordner
    const defaultImages = [
        "IMG_6765.jpeg",
        "IMG_6883.jpeg",
        "DSC00057.JPG",
        "20190527_122826.jpg",
        "20220628_221935.jpg",
        "IMG_3410.jpeg",
        "IMG_3411.jpeg"
    ];

    // Auth state listener
    auth.onAuthStateChanged((user) => {
        if (user) {
            showAdminContent(user);
        } else {
            showLoginForm();
        }
    });

    function showLoginForm() {
        loginSection.style.display = 'block';
        adminContent.style.display = 'none';
        loginError.style.display = 'none';
        loginLoading.style.display = 'none';
    }

    function showAdminContent(user) {
        loginSection.style.display = 'none';
        adminContent.style.display = 'block';
        userEmail.textContent = user.email;

        // Initialize admin functionality
        initializeAdmin();
    }

    function initializeAdmin() {
        // Initialize image management
        initializeImageManagement();

        // Initial Etappe field
        addEtappeField();

        // Event listeners
        addEtappeBtn.addEventListener('click', () => addEtappeField());
        editAddEtappeBtn.addEventListener('click', () => addEtappeField(true));
        loadToursBtn.addEventListener('click', loadTours);
        cancelEditBtn.addEventListener('click', cancelEdit);

        // Image management event listeners
        loadImagesBtn.addEventListener('click', loadCurrentImages);
        saveImagesBtn.addEventListener('click', saveImages);
        resetImagesBtn.addEventListener('click', resetToDefaults);
        selectImageBtn.addEventListener('click', selectImage);
        
        // Upload functionality event listeners
        imageUpload.addEventListener('change', handleFileSelect);
        uploadImageBtn.addEventListener('click', handleImageUpload);
        cancelUploadBtn.addEventListener('click', cancelImageUpload);
    }

    // Image Management Functions
    function initializeImageManagement() {
        availableImages = [...defaultImages];
        currentSliderImages = [...defaultImages.slice(0, 5)]; // Default ersten 5 Bilder
        renderImageSlots();
        loadCurrentImages(); // This will also load uploaded images
    }

    function renderImageSlots() {
        imageSlotsContainer.innerHTML = '';

        for (let i = 0; i < 5; i++) {
            const slot = document.createElement('div');
            slot.className = 'image-slot';
            slot.dataset.index = i;

            const hasImage = currentSliderImages[i];
            if (hasImage) {
                slot.classList.add('has-image');
            }

            const imageName = currentSliderImages[i];
            const isUploadedImage = imageName && imageName.startsWith('uploaded_');
            const imageUrl = hasImage ? 
                (isUploadedImage ? '#' : `assets/drfImg/${imageName}`) : '';
            
            slot.innerHTML = `
                <div>
                    ${hasImage ? `<img src="${imageUrl}" alt="Slider Bild ${i + 1}" class="image-preview" data-image-name="${imageName}">` : '<div style="width:120px;height:80px;background:#f0f0f0;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#999;"><i class="fas fa-image"></i></div>'}
                </div>
                <div class="image-info">
                    <h6>Position ${i + 1}</h6>
                    <small>${hasImage ? imageName : 'Kein Bild ausgew√§hlt'}</small>
                </div>
                <div class="image-actions">
                    <button type="button" class="btn btn-sm btn-primary" onclick="openImageSelector(${i})">
                        ${hasImage ? '√Ñndern' : 'Ausw√§hlen'}
                    </button>
                    ${hasImage ? `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImage(${i})">Entfernen</button>` : ''}
                </div>
            `;

            // Load uploaded image data if needed
            if (hasImage && isUploadedImage) {
                loadUploadedImagePreview(imageName, slot.querySelector('.image-preview'));
            }

            imageSlotsContainer.appendChild(slot);
        }
    }

    function openImageSelector(slotIndex) {
        currentEditingSlot = slotIndex;
        selectedImageIndex = -1;
        uploadedFile = null;
        currentSlotSpan.textContent = slotIndex + 1;
        
        // Reset upload form
        imageUpload.value = '';
        uploadPreview.style.display = 'none';

        // Render verf√ºgbare Bilder
        availableImagesContainer.innerHTML = '';
        availableImages.forEach((image, index) => {
            const imageEl = document.createElement('div');
            imageEl.className = 'available-image';
            imageEl.dataset.index = index;
            imageEl.onclick = () => selectAvailableImage(index);

            const isUploaded = image.startsWith('uploaded_');
            const imgElement = document.createElement('img');
            imgElement.alt = image;
            
            if (isUploaded) {
                loadUploadedImagePreview(image, imgElement);
            } else {
                imgElement.src = `assets/drfImg/${image}`;
            }

            const textDiv = document.createElement('div');
            textDiv.innerHTML = `
                <strong>${image}</strong>
                <small class="d-block text-muted">${isImageInUse(image) ? '‚úì Bereits verwendet' : 'Verf√ºgbar'}</small>
            `;

            imageEl.appendChild(imgElement);
            imageEl.appendChild(textDiv);
            availableImagesContainer.appendChild(imageEl);
        });

        selectImageBtn.disabled = true;
        imageSelectModal.show();
    }

    function selectAvailableImage(index) {
        // Remove previous selection
        document.querySelectorAll('.available-image').forEach(el => el.classList.remove('selected'));

        // Add selection to clicked image
        const selectedEl = document.querySelector(`[data-index="${index}"]`);
        selectedEl.classList.add('selected');

        selectedImageIndex = index;
        selectImageBtn.disabled = false;
    }

    function selectImage() {
        if (selectedImageIndex >= 0) {
            currentSliderImages[currentEditingSlot] = availableImages[selectedImageIndex];
            renderImageSlots();
            imageSelectModal.hide();
        }
    }

    function removeImage(slotIndex) {
        currentSliderImages[slotIndex] = null;
        renderImageSlots();
    }

    function isImageInUse(imageName) {
        return currentSliderImages.includes(imageName);
    }

    async function loadCurrentImages() {
        try {
            // Load current slider images
            const doc = await db.collection('settings').doc('slider-images').get();
            if (doc.exists) {
                const data = doc.data();
                currentSliderImages = data.images || [...defaultImages.slice(0, 5)];
            } else {
                currentSliderImages = [...defaultImages.slice(0, 5)];
            }
            
            // Load available uploaded images
            const uploadedImagesSnapshot = await db.collection('uploaded-images').get();
            const uploadedImages = uploadedImagesSnapshot.docs.map(doc => doc.id);
            
            // Combine default and uploaded images
            availableImages = [...defaultImages, ...uploadedImages];
            
            renderImageSlots();
            showMessage('Aktuelle Bilder geladen', 'success');
        } catch (error) {
            console.error('Fehler beim Laden der Bilder:', error);
            showMessage('Fehler beim Laden der Bilder', 'danger');
        }
    }

    async function saveImages() {
        // Validierung: Alle 5 Slots m√ºssen gef√ºllt sein
        if (currentSliderImages.some(img => !img)) {
            showMessage('Bitte w√§hlen Sie f√ºr alle 5 Positionen ein Bild aus', 'warning');
            return;
        }

        try {
            await db.collection('settings').doc('slider-images').set({
                images: currentSliderImages,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage('Slider-Bilder erfolgreich gespeichert!', 'success');
        } catch (error) {
            console.error('Fehler beim Speichern:', error);
            showMessage('Fehler beim Speichern der Bilder', 'danger');
        }
    }

    function resetToDefaults() {
        currentSliderImages = [...defaultImages.slice(0, 5)];
        renderImageSlots();
        showMessage('Auf Standard-Bilder zur√ºckgesetzt', 'info');
    }

    // Upload functionality
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
            uploadPreview.style.display = 'none';
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showMessage('Bitte w√§hlen Sie eine g√ºltige Bilddatei aus', 'warning');
            event.target.value = '';
            return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showMessage('Das Bild ist zu gro√ü. Maximale Gr√∂√üe: 5MB', 'warning');
            event.target.value = '';
            return;
        }

        uploadedFile = file;

        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            uploadPreview.style.display = 'block';
            
            // Deselect any previously selected existing image
            document.querySelectorAll('.available-image').forEach(el => el.classList.remove('selected'));
            selectedImageIndex = -1;
            selectImageBtn.disabled = true;
        };
        reader.readAsDataURL(file);
    }

    async function handleImageUpload() {
        if (!uploadedFile) {
            showMessage('Keine Datei ausgew√§hlt', 'warning');
            return;
        }

        try {
            uploadImageBtn.disabled = true;
            uploadImageBtn.textContent = 'Wird hochgeladen...';

            // Generate unique filename
            const timestamp = Date.now();
            const extension = uploadedFile.name.split('.').pop().toLowerCase();
            const fileName = `uploaded_${timestamp}.${extension}`;

            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                
                try {
                    // Save image data to Firestore
                    await db.collection('uploaded-images').doc(fileName).set({
                        fileName: fileName,
                        data: base64Data,
                        contentType: uploadedFile.type,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Add to available images list
                    availableImages.push(fileName);
                    
                    // Set as current selection and close modal
                    currentSliderImages[currentEditingSlot] = fileName;
                    renderImageSlots();
                    imageSelectModal.hide();
                    
                    showMessage('Bild erfolgreich hochgeladen und ausgew√§hlt!', 'success');
                } catch (error) {
                    console.error('Upload error:', error);
                    showMessage('Fehler beim Hochladen des Bildes', 'danger');
                }
                
                uploadImageBtn.disabled = false;
                uploadImageBtn.textContent = 'Hochladen';
            };
            reader.readAsDataURL(uploadedFile);

        } catch (error) {
            console.error('Upload error:', error);
            showMessage('Fehler beim Hochladen des Bildes', 'danger');
            uploadImageBtn.disabled = false;
            uploadImageBtn.textContent = 'Hochladen';
        }
    }

    function cancelImageUpload() {
        imageUpload.value = '';
        uploadPreview.style.display = 'none';
        uploadedFile = null;
    }

    async function loadUploadedImagePreview(imageName, imgElement) {
        try {
            const doc = await db.collection('uploaded-images').doc(imageName).get();
            if (doc.exists) {
                const data = doc.data();
                const base64Src = `data:${data.contentType};base64,${data.data}`;
                imgElement.src = base64Src;
            }
        } catch (error) {
            console.error('Error loading uploaded image:', error);
        }
    }

    function showMessage(message, type = 'info') {
        // Remove existing alerts
        document.querySelectorAll('.temp-alert').forEach(alert => alert.remove());

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} temp-alert`;
        alert.textContent = message;
        alert.style.position = 'fixed';
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '9999';
        alert.style.minWidth = '300px';

        document.body.appendChild(alert);

        setTimeout(() => alert.remove(), 3000);
    }

    // Login form handler
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        loginError.style.display = 'none';
        loginLoading.style.display = 'block';

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            loginLoading.style.display = 'none';
            loginError.style.display = 'block';

            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    loginError.textContent = 'Ung√ºltige E-Mail oder Passwort.';
                    break;
                case 'auth/too-many-requests':
                    loginError.textContent = 'Zu viele fehlgeschlagene Anmeldeversuche. Bitte versuche es sp√§ter erneut.';
                    break;
                default:
                    loginError.textContent = 'Anmeldung fehlgeschlagen. Bitte versuche es erneut.';
            }
        }
    });

    // Logout button handler
    logoutBtn.addEventListener('click', () => {
        auth.signOut();
    });

    function addEtappeField(isEdit = false) {
        const container = isEdit ? editEtappenContainer : etappenContainer;
        const wrapper = document.createElement('div');
        wrapper.classList.add('etappe-group', 'border', 'p-3', 'mb-3', 'rounded');
        wrapper.innerHTML = `
        <div class="mb-2">
          <label class="form-label">Datum</label>
          <input type="date" class="form-control etappe-date" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Titel</label>
          <input type="text" class="form-control etappe-title" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Cyclemeter Link</label>
          <input type="url" class="form-control etappe-url" required>
        </div>
        <button type="button" class="btn btn-sm btn-danger remove-etappe-btn">‚Äì Etappe entfernen</button>
      `;
        container.appendChild(wrapper);

        wrapper.querySelector('.remove-etappe-btn').addEventListener('click', () => {
            wrapper.remove();
        });
    }

    function cancelEdit() {
        editSection.classList.remove('show');
        createSection.style.display = 'block';
        currentEditTourId = null;

        document.getElementById('editTourForm').reset();
        editEtappenContainer.innerHTML = '';
    }

    async function editTour(tourId, tourName) {
        try {
            currentEditTourId = tourId;

            createSection.style.display = 'none';
            editSection.classList.add('show');

            const tourDoc = await db.collection('tours').doc(tourId).get();
            const tourData = tourDoc.data();

            document.getElementById('editTourId').value = tourData.name;
            document.getElementById('editTourDesc').value = tourData.description || '';

            editEtappenContainer.innerHTML = '';

            const etappenSnapshot = await db.collection('tours').doc(tourId).collection('etappen').orderBy('date').get();

            etappenSnapshot.forEach(etappeDoc => {
                const etappe = etappeDoc.data();
                addEtappeField(true);

                const lastEtappeGroup = editEtappenContainer.lastElementChild;
                lastEtappeGroup.querySelector('.etappe-date').value = etappe.date;
                lastEtappeGroup.querySelector('.etappe-title').value = etappe.title;
                lastEtappeGroup.querySelector('.etappe-url').value = etappe.url;
                lastEtappeGroup.dataset.etappeId = etappeDoc.id;
            });

            if (etappenSnapshot.empty) {
                addEtappeField(true);
            }

            editSection.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error('Fehler beim Laden der Tour:', error);
            alert('Fehler beim Laden der Tour-Daten.');
        }
    }

    async function loadTours() {
        toursList.innerHTML = '<div class="loading">Lade Touren...</div>';

        try {
            const snapshot = await db.collection('tours').orderBy('name', 'desc').get();

            if (snapshot.empty) {
                toursList.innerHTML = '<p class="text-muted">Keine Touren gefunden.</p>';
                return;
            }

            toursList.innerHTML = '';

            for (const doc of snapshot.docs) {
                const data = doc.data();
                const etappenSnapshot = await db.collection('tours').doc(doc.id).collection('etappen').orderBy('date').get();
                const etappenCount = etappenSnapshot.size;

                const tourDiv = document.createElement('div');
                tourDiv.className = 'tour-item';
                tourDiv.id = `tour-${doc.id}`;

                const headerDiv = document.createElement('div');
                headerDiv.className = 'tour-header';
                headerDiv.innerHTML = `
                <div class="tour-info">
                    <h6>${data.name}</h6>
                    <small class="text-muted">
                        ${etappenCount} Etappe${etappenCount !== 1 ? 'n' : ''}
                        ${data.description ? ' ‚Ä¢ ' + data.description.substring(0, 50) + (data.description.length > 50 ? '...' : '') : ''}
                    </small>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-toggle-etappen btn-sm" data-tour-id="${doc.id}">
                        Etappen anzeigen
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm edit-tour-btn" data-tour-id="${doc.id}" data-tour-name="${data.name}">
                        Bearbeiten
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm delete-tour-btn" data-tour-id="${doc.id}" data-tour-name="${data.name}">
                        L√∂schen
                    </button>
                </div>
            `;

                const etappenDiv = document.createElement('div');
                etappenDiv.className = 'etappen-list';
                etappenDiv.id = `etappen-${doc.id}`;

                if (etappenCount > 0) {
                    etappenSnapshot.forEach(etappeDoc => {
                        const etappe = etappeDoc.data();
                        const etappeItem = document.createElement('div');

                        // Pr√ºfe auf Platzhalter
                        const isPlaceholder = etappe.date === '???' || etappe.title === '???' || etappe.url === '???';
                        const hasNoValidUrl = !etappe.url || etappe.url === '???' || !etappe.url.startsWith('http');

                        etappeItem.className = 'etappe-item';
                        if (isPlaceholder || hasNoValidUrl) {
                            etappeItem.classList.add('etappe-placeholder');
                        }

                        let warningText = '';
                        if (isPlaceholder) {
                            warningText = '<div class="placeholder-warning">‚ö†Ô∏è Platzhalter-Daten - bitte vervollst√§ndigen</div>';
                        } else if (hasNoValidUrl) {
                            warningText = '<div class="placeholder-warning">‚ö†Ô∏è Kein g√ºltiger Link vorhanden</div>';
                        }

                        etappeItem.innerHTML = `
                        <div class="etappe-info">
                            <strong>${etappe.date} ‚Äì ${etappe.title}</strong>
                            <small>
                                ${etappe.url && etappe.url !== '???' && etappe.url.startsWith('http')
                            ? `<a href="${etappe.url}" target="_blank" class="text-decoration-none">üîó Link anzeigen</a>`
                            : '<span class="text-muted">üîó Kein Link verf√ºgbar</span>'
                        }
                            </small>
                            ${warningText}
                        </div>
                        <button class="btn btn-outline-danger btn-sm delete-etappe-btn"
                                data-tour-id="${doc.id}"
                                data-etappe-id="${etappeDoc.id}"
                                data-etappe-title="${etappe.title}">
                            Etappe l√∂schen
                        </button>
                    `;
                        etappenDiv.appendChild(etappeItem);
                    });
                } else {
                    etappenDiv.innerHTML = '<p class="text-muted small">Keine Etappen vorhanden.</p>';
                }

                tourDiv.appendChild(headerDiv);
                tourDiv.appendChild(etappenDiv);
                toursList.appendChild(tourDiv);
            }

            addEventListeners();

        } catch (error) {
            console.error('Fehler beim Laden der Touren:', error);
            toursList.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Touren.</div>';
        }
    }

    function addEventListeners() {
        document.querySelectorAll('.btn-toggle-etappen').forEach(btn => {
            btn.addEventListener('click', function() {
                const tourId = this.getAttribute('data-tour-id');
                toggleEtappen(tourId, this);
            });
        });

        document.querySelectorAll('.edit-tour-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tourId = this.getAttribute('data-tour-id');
                const tourName = this.getAttribute('data-tour-name');
                editTour(tourId, tourName);
            });
        });

        document.querySelectorAll('.delete-tour-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tourId = this.getAttribute('data-tour-id');
                const tourName = this.getAttribute('data-tour-name');
                deleteTour(tourId, tourName);
            });
        });

        document.querySelectorAll('.delete-etappe-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tourId = this.getAttribute('data-tour-id');
                const etappeId = this.getAttribute('data-etappe-id');
                const etappeTitle = this.getAttribute('data-etappe-title');
                deleteEtappe(tourId, etappeId, etappeTitle);
            });
        });
    }

    function toggleEtappen(tourId, button) {
        const etappenDiv = document.getElementById(`etappen-${tourId}`);

        if (etappenDiv.classList.contains('show')) {
            etappenDiv.classList.remove('show');
            button.textContent = 'Etappen anzeigen';
        } else {
            etappenDiv.classList.add('show');
            button.textContent = 'Etappen ausblenden';
        }
    }

    async function deleteEtappe(tourId, etappeId, etappeTitle) {
        const confirmed = confirm(`M√∂chtest du die Etappe "${etappeTitle}" wirklich l√∂schen?\n\nDies kann nicht r√ºckg√§ngig gemacht werden!`);

        if (!confirmed) return;

        try {
            await db.collection('tours').doc(tourId).collection('etappen').doc(etappeId).delete();
            alert(`Etappe "${etappeTitle}" wurde erfolgreich gel√∂scht!`);
            loadTours();
        } catch (error) {
            console.error('Fehler beim L√∂schen der Etappe:', error);
            alert('Fehler beim L√∂schen der Etappe. Bitte versuche es erneut.');
        }
    }

    async function deleteTour(tourId, tourName) {
        const confirmed = confirm(`M√∂chtest du die Tour "${tourName}" wirklich l√∂schen?\n\nDies wird auch alle zugeh√∂rigen Etappen l√∂schen und kann nicht r√ºckg√§ngig gemacht werden!`);

        if (!confirmed) return;

        try {
            const etappenSnapshot = await db.collection('tours').doc(tourId).collection('etappen').get();
            const batch = db.batch();

            etappenSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            batch.delete(db.collection('tours').doc(tourId));
            await batch.commit();

            alert(`Tour "${tourName}" wurde erfolgreich gel√∂scht!`);
            loadTours();
        } catch (error) {
            console.error('Fehler beim L√∂schen:', error);
            alert('Fehler beim L√∂schen der Tour. Bitte versuche es erneut.');
        }
    }

    // Create tour form
    document.getElementById('fullTourForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('tourId').value.trim();
        const description = document.getElementById('tourDesc').value.trim();
        const etappeGroups = document.querySelectorAll('#etappenContainer .etappe-group');

        if (etappeGroups.length === 0) {
            alert("Mindestens eine Etappe hinzuf√ºgen!");
            return;
        }

        try {
            await db.collection('tours').doc(id).set({ name: id, description });

            for (const group of etappeGroups) {
                const date = group.querySelector('.etappe-date').value;
                const title = group.querySelector('.etappe-title').value.trim();
                const url = group.querySelector('.etappe-url').value.trim();

                await db.collection('tours').doc(id).collection('etappen').add({ date, title, url });
            }

            alert("Tour und Etappen erfolgreich gespeichert!");
            e.target.reset();
            etappenContainer.innerHTML = '';
            addEtappeField();

            if (toursList.innerHTML && !toursList.innerHTML.includes('Touren laden')) {
                loadTours();
            }

        } catch (err) {
            console.error(err);
            alert("Fehler beim Speichern.");
        }
    });

    // Edit tour form
    document.getElementById('editTourForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentEditTourId) {
            alert("Keine Tour zum Bearbeiten ausgew√§hlt!");
            return;
        }

        const description = document.getElementById('editTourDesc').value.trim();
        const etappeGroups = document.querySelectorAll('#editEtappenContainer .etappe-group');

        if (etappeGroups.length === 0) {
            alert("Mindestens eine Etappe hinzuf√ºgen!");
            return;
        }

        try {
            await db.collection('tours').doc(currentEditTourId).update({ description });

            const existingEtappen = await db.collection('tours').doc(currentEditTourId).collection('etappen').get();
            const batch = db.batch();

            existingEtappen.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();

            for (const group of etappeGroups) {
                const date = group.querySelector('.etappe-date').value;
                const title = group.querySelector('.etappe-title').value.trim();
                const url = group.querySelector('.etappe-url').value.trim();

                await db.collection('tours').doc(currentEditTourId).collection('etappen').add({ date, title, url });
            }

            alert("Tour erfolgreich aktualisiert!");
            cancelEdit();
            loadTours();

        } catch (err) {
            console.error(err);
            alert("Fehler beim Aktualisieren.");
        }
    });
</script>

</body>
</html>